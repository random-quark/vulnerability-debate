const WebSocket = require("ws");
const SerialPort = require("serialport");
const port = new SerialPort(
  "/dev/cu.usbmodem14101",
  {
    baudRate: 9600
  },
  function(err) {
    if (err) {
      return console.log("Error: ", err.message);
    }
  }
);

// Open errors will be emitted as an error event
port.on("error", function(err) {
  console.log("Error: ", err.message);
});

const parser = new SerialPort.parsers.Readline();
port.pipe(parser);

const wss = new WebSocket.Server({ port: 8080 });

parser.on("data", data => {
  console.log(data);
  wss.clients.forEach(function each(client) {
    if (client.readyState === WebSocket.OPEN) {
      client.send(data);
    } else {
      console.error(
        "A client did not get a message because readyState was false"
      );
    }
  });
});
